## Update user-chat index entry in place with the latest metadata.
## SK uses chatId only (not timestamp) so concurrent updates are safe â€” last writer wins.
#set($meta = $ctx.stash.chatMeta)
#set($updatedMeta = $ctx.stash.updatedMeta)
#set($internalUserId = $meta.internalUserId)
#set($chatId = $ctx.args.input.chatId)
{
  "version": "2017-02-28",
  "operation": "PutItem",
  "key": {
    "PK": $util.dynamodb.toDynamoDBJson("USER#${internalUserId}"),
    "SK": $util.dynamodb.toDynamoDBJson("CHAT#${chatId}")
  },
  "attributeValues": $util.dynamodb.toMapValuesJson({
    "chatId": "${chatId}",
    "title": "$updatedMeta.title",
    "providerId": $util.defaultIfNull($updatedMeta.providerId, "claude"),
    "createdAt": "$updatedMeta.createdAt",
    "updatedAt": "$updatedMeta.updatedAt",
    "messageCount": $updatedMeta.messageCount
  })
}
