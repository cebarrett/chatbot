## Delete old user-chat index entry and write new one with updated timestamp
## We need to find the old SK first, then delete and rewrite
#set($meta = $ctx.stash.chatMeta)
#set($updatedMeta = $ctx.stash.updatedMeta)
#set($userId = $meta.userId)
#set($chatId = $ctx.args.input.chatId)
#set($newUpdatedAt = $updatedMeta.updatedAt)
#set($oldUpdatedAt = $meta.updatedAt)
{
  "version": "2018-05-29",
  "operation": "BatchPutItem",
  "tables": {
    "${tableName}": [
      $util.dynamodb.toMapValuesJson({
        "PK": "USER#${userId}",
        "SK": "CHAT#${newUpdatedAt}#${chatId}",
        "chatId": "${chatId}",
        "title": "$updatedMeta.title",
        "providerId": $util.defaultIfNull($updatedMeta.providerId, "claude"),
        "createdAt": "$updatedMeta.createdAt",
        "updatedAt": "${newUpdatedAt}",
        "messageCount": $updatedMeta.messageCount
      })
    ]
  }
}
